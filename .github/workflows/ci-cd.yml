name: CI

on: [push]

jobs:
  build: # Задача для установки зависимостей
    runs-on: ubuntu-latest # Указываю, на какой операционной системе будет выполняться задача
    steps:
      - name: Checkout code
      - uses: actions/checkout@v4 # Клонирую репозиторий в рабочую директорию
      - run: echo "The ${{ github.repository }} repository has been cloned to the runner."
      - name: Composer install
      - uses: php-actions/composer@v6 # Выполняю команду "composer install" для установки необходимых зависимостией
      - run: echo "Composer dependencies have been installed"
  # Задача для тестирования
  test:
    needs: build # Задача для тестирования выполняется только после успешного завершения задачи для установке зависимостей
    runs-on: ubuntu-latest # Указываю, на какой операционной системе будет выполняться задача
    steps:
      - name: Checkout code
      - uses: actions/checkout@v4 # Клонирую репозиторий в рабочую директорию
      - run: echo "The ${{ github.repository }} repository has been cloned to the runner."
      - name: Composer install
      - uses: php-actions/composer@v6 # Выполняю команду "composer install" для установки необходимых зависимостией
      - run: echo "Composer dependencies have been installed"
      - run: vendor/bin/phpunit --verbose tests
  deploy: # Задача для деплоя
    needs: test # Задача для деплоя выполняется только после успешного завершения задачи для тестированию
    runs-on: ubuntu-latest # Указываю, на какой операционной системе будет выполняться задача
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Клонирую репозиторий в рабочую директорию
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
      - name: Deploy to server
        run: |
          echo "Starting deployment..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no borisey@95.142.44.94 "cd /var/www/html/php_app && git pull origin main"
          echo "Deployment completed."